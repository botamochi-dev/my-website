name: Auto-merge dependencies

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: |
      (github.actor == 'dependabot[bot]' || github.actor == 'renovate[bot]') &&
      (contains(github.event.pull_request.labels.*.name, 'dependencies') ||
       contains(github.event.pull_request.labels.*.name, 'renovate'))
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              const run = context.payload.check_suite;
              if (run && run.pull_requests && run.pull_requests.length > 0) {
                const prNumber = run.pull_requests[0].number;
                const { data: prData } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                return prData;
              }
              return null;
            }
            return pr;

      - name: Auto-approve PR
        if: steps.pr.outputs.result != 'null'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.pr.outputs.result != 'null'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER=$(echo '${{ steps.pr.outputs.result }}' | jq -r '.number')
          fi
          gh pr merge "$PR_NUMBER" --auto --squash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
